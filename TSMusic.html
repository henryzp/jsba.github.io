<!DOCTYPE HTML>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
        <meta name="author" content="Intptr" />
        <title>TSMusic</title>
        <script type="text/javascript" src="libs/zlib.min.js"></script>
        <script type="text/javascript">
            window.onload = function() {
                var URL = window.URL || window.webkitURL;
                var AudioContext = window.AudioContext || window.webkitAudioContext;
                if (! (window.FileReader && window.Blob && window.Audio && URL && AudioContext)) {
                    alert("您的浏览器不支持此应用！");
                    return;
                }
                var canvas = document.getElementById("lyric");
                var context = canvas.getContext("2d");
                var text_fill = context.createLinearGradient(0, 0, 0, 50);
                text_fill.addColorStop(0, "rgb(37,152,10)");
                text_fill.addColorStop(1, "rgb(129,249,0)");
                var mask_fill = context.createLinearGradient(0, 0, 0, 50);
                mask_fill.addColorStop(0, "rgb(253,232,0)");
                mask_fill.addColorStop(0.5, "rgb(255,120,0)");
                mask_fill.addColorStop(1, "rgb(255,246,0)");
                var lyric_text = "";
                var lyric_percent = 0;
                var canvas_width = 0;
                function draw() {
                    var lyric_width = context.measureText(lyric_text).width;
                    context.clearRect(0, 0, canvas_width, 50);
                    context.save();
                    context.lineWidth = 2;
                    context.shadowColor = "#000000";
                    context.shadowBlur = 1;
                    context.shadowOffsetX = 2;
                    context.shadowOffsetY = 2;
                    context.fillText(lyric_text, (canvas_width - lyric_width) / 2, 25);
                    context.strokeText(lyric_text, (canvas_width - lyric_width) / 2, 25);
                    context.restore();
                    context.save();
                    context.lineWidth = 2;
                    context.fillStyle = text_fill;
                    context.strokeStyle = text_fill;
                    context.fillText(lyric_text, (canvas_width - lyric_width) / 2, 25);
                    context.strokeText(lyric_text, (canvas_width - lyric_width) / 2, 25);
                    context.beginPath();
                    context.rect((canvas_width - lyric_width) / 2, 0, lyric_width * lyric_percent / 100, 50);
                    context.clip();
                    context.fillStyle = mask_fill;
                    context.strokeStyle = mask_fill;
                    context.fillText(lyric_text, (canvas_width - lyric_width) / 2, 25);
                    context.strokeText(lyric_text, (canvas_width - lyric_width) / 2, 25);
                    context.restore();
                }
                function resize() {
                    canvas.width = canvas_width = document.body.clientWidth;
                    context.font = "32px Arial";
                    context.textBaseline = "middle";
                    context.textAlign = "left";
                    draw();
                }
                window.onresize = resize;
                resize();
                var timer = null;
                var music_file = document.getElementById("music-file");
                var lyric_file = document.getElementById("lyric-file");
                var submit_file = document.getElementById("submit-file");
                function clear_lyric() {
                    clearTimeout(timer);
                    lyric_text = "Music Player";
                    draw();
                }
                function load_lyric(text) {
                    text = text.split("\n");
                    var lyric = [];
                    for (var i = 0; i < text.length; i++) {
                        var m;
                        if (m = text[i].match(/^(?:\[-?\d+:\d+\.\d+\])+([\s\S]*?)$/)) {
                            var l = m[1].trim();
                            l = l ? l: "Music...";
                            var t = text[i].match(/\[-?\d+:\d+\.\d+\]/g);
                            for (var j = 0; j < t.length; j++) {
                                var tm = t[j].match(/\[(-?)(\d+):(\d+)\.(\d+)\]/);
                                var time = parseInt(tm[2], 10) * 60 * 1000 + parseInt(tm[3], 10) * 1000 + parseInt(tm[4], 10) * 10;
                                if (tm[1] == "-") {
                                    time = -time;
                                }
                                lyric.push({
                                    time: time,
                                    lyric: l
                                });
                            }
                        }
                    }
                    for (var i = 0; i < text.length; i++) {
                        var m;
                        if (m = text[i].match(/^\[offset:(-?\d+)\]$/)) {
                            var offset = parseInt(m[1], 10);
                            for (var i = 0; i < lyric.length; i++) {
                                lyric[i].time += offset;
                            }
                        }
                    }
                    lyric.sort(function(a, b) {
                        return a.time - b.time;
                    });
                    lyric.splice(0, 0, {
                        time: -1E10,
                        lyric: "Music..."
                    });
                    lyric.push({
                        time: 1E10,
                        lyric: "Music..."
                    });
                    (function() {
                        var time = audio.currentTime * 1000;
                        var flag = false;
                        for (var i = 0; i < lyric.length - 1; i++) {
                            if (lyric[i].time <= time && time < lyric[i + 1].time) {
                                lyric_text = lyric[i].lyric;
                                lyric_percent = (time - lyric[i].time) / (lyric[i + 1].time - lyric[i].time) * 100;
                                flag = true;
                                break;
                            }
                        }
                        if (!flag) {
                            lyric_text = "Music...";
                            lyric_percent = 0;
                        }
                        draw();
                        timer = setTimeout(arguments.callee, 50);
                    })();
                }
                var utf_8_test = new RegExp([
                    "[\xC0-\xDF]([^\x80-\xBF]|$)",
                    "[\xE0-\xEF].{0,1}([^\x80-\xBF]|$)",
                    "[\xF0-\xF7].{0,2}([^\x80-\xBF]|$)",
                    "[\xF8-\xFB].{0,3}([^\x80-\xBF]|$)",
                    "[\xFC-\xFD].{0,4}([^\x80-\xBF]|$)",
                    "[\xFE-\xFE].{0,5}([^\x80-\xBF]|$)",
                    "[\x00-\x7F][\x80-\xBF]",
                    "[\xC0-\xDF].[\x80-\xBF]",
                    "[\xE0-\xEF]..[\x80-\xBF]",
                    "[\xF0-\xF7]...[\x80-\xBF]",
                    "[\xF8-\xFB]....[\x80-\xBF]",
                    "[\xFC-\xFD].....[\x80-\xBF]",
                    "[\xFE-\xFE]......[\x80-\xBF]",
                    "^[\x80-\xBF]"
                ].join("|"));
                function read_text_from_blob(blob, handle) {
                    var reader, result;
                    reader = new FileReader();
                    reader.readAsText(blob, "utf-8");
                    reader.onload = function() {
                        result = this.result;
                        if (!utf_8_test.test(result)) {
                            handle(result);
                        } else {
                            reader = new FileReader();
                            reader.readAsText(blob, "gbk");
                            reader.onload = function() {
                                result = this.result;
                                handle(result);
                            };
                        }
                    };
                }
                function read_text_from_array(array, handle) {
                    if (array instanceof ArrayBuffer) {
                        array = new Uint8Array(array);
                    }
                    var blob = new Blob([array]);
                    read_text_from_blob(blob, handle);
                }
                var krc_keys = [0x40, 0x47, 0x61, 0x77, 0x5e, 0x32, 0x74, 0x47, 0x51, 0x36, 0x31, 0x2d, 0xce, 0xd2, 0x6e, 0x69];
                function uint8_array_to_string(array) {
                    var str = "";
                    for (var i = 0; i < array.length; i++) {
                        str += String.fromCharCode(array[i]);
                    }
                    return str;
                };
                function zero_fill(str, len) {
                    for (var i = 0; i < len - str.length; i++) {
                        str = "0" + str;
                    }
                    return str;
                };
                function time_to_string(time) {
                    var h;
                    var str = "[";
                    if (time < 0) {
                        str += "-";
                        time = -time;
                    }
                    if (h = Math.floor(time / 60 / 60 / 1000)) {
                        str += zero_fill(h.toString(), 2);
                        str += ":";
                    }
                    str += zero_fill((Math.floor(time / 60 / 1000) % 60).toString(), 2);
                    str += ":";
                    str += zero_fill((Math.floor(time / 1000) % 60).toString(), 2);
                    str += ".";
                    str += zero_fill(Math.floor((time % 1000) / 10).toString(), 2);
                    str += "]";
                    return str;
                };
                function krc_to_lrc(krc, handle) {
                    var buffer, array, list, before, result, match, start, duration, data, after, i, j;
                    buffer = new Uint8Array(krc.slice(0, 4));
                    if (uint8_array_to_string(buffer).toLowerCase() == "krc1") {
                        array = new Uint8Array(krc.slice(4));
                        for (i = 0; i < array.length; i++) {
                            array[i] ^= krc_keys[i % krc_keys.length];
                        }
                        read_text_from_array((new Zlib.Inflate(array)).decompress(),
                        function(text) {
                            text = text.replace(/<-?\d+,-?\d+,-?\d+>/g, "");
                            list = text.split("\n");
                            result = [];
                            before = null;
                            after = null;
                            for (i = 0; i < list.length; i++) {
                                if (list[i] = list[i].trim()) {
                                    if (match = list[i].match(/^\[(-?\d+),(-?\d+)\]([\s\S]*?)$/)) {
                                        start = parseInt(match[1], 10);
                                        duration = parseInt(match[2], 10);
                                        data = match[3].trim();
                                        if (!data) {
                                            continue;
                                        }
                                        if (before !== null) {
                                            if (Math.abs(start - before) > 1000) {
                                                result.push(time_to_string(before));
                                            }
                                        }
                                        if (after) {
                                            for (var i = 0; i < after.length; i++) {
                                                result.push(after[i]);
                                            }
                                            after = null;
                                        }
                                        result.push(time_to_string(start) + data);
                                        before = start + duration;
                                    } else {
                                        if (!after) {
                                            after = [];
                                        }
                                        after.push([list[i]]);
                                    }
                                }
                            }
                            if (before !== null) {
                                result.push(time_to_string(before));
                            }
                            if (after) {
                                for (var i = 0; i < after.length; i++) {
                                    result.push(after[i]);
                                }
                            }
                            handle(result.join("\n"));
                        });
                    } else {
                        handle("");
                    }
                };
                function get_handle(handle, delay, max) {
                    var timer = -1;
                    var t_start;
                    return function() {
                        var self = this;
                        var args = arguments;
                        var t_current = new Date().getTime();
                        clearTimeout(timer);
                        if (!t_start) {
                            t_start = t_current;
                        }
                        if (t_current - t_start >= max) {
                            handle.apply(self, args);
                            t_start = t_current;
                        } else {
                            timer = setTimeout(function() {
                                handle.apply(self, args);
                                t_start = t_current;
                            },
                            delay);
                        }
                    };
                }
                var audio = null;
                var audio_context = new AudioContext();
                var media_source = null;
                var script_processor = audio_context.createScriptProcessor(4096);
                var audio_analyser = audio_context.createAnalyser();
                var gain_node = audio_context.createGainNode();
                script_processor.connect(audio_context.destination);
                audio_analyser.connect(gain_node);
                gain_node.connect(audio_context.destination);
                var spectrum_canvas = document.getElementById("spectrum");
                var spectrum_context = spectrum_canvas.getContext("2d");
                var toggle = document.getElementById("toggle");
                var slider = document.getElementById("slider");
                var mute = document.getElementById("mute");
                var volume = document.getElementById("volume");
                var playing = false;
                var isdown = false;
                var muted = false;
                function play() {
                    if (audio) {
                        audio.play();
                        playing = true;
                        toggle.value = "暂停";
                    }
                }
                function pause() {
                    if (audio) {
                        audio.pause();
                        playing = false;
                        toggle.value = "播放";
                    }
                }
                toggle.onclick = function() {
                    if (playing) {
                        pause();
                    } else {
                        play();
                    }
                };
                var slide = get_handle(function() {
                    isdown = false;
                    if (audio) {
                        audio.currentTime = slider.value;
                    }
                },
                200, 500);
                slider.onchange = function() {
                    isdown = true;
                    slide();
                };
                mute.onclick = function() {
                    muted = !muted;
                    if (muted) {
                        gain_node.gain.value = 0;
                        mute.value="打开音量";
                    } else {
                        gain_node.gain.value = volume.value;
                        mute.value="关闭音量";
                    }
                };
                volume.onchange = get_handle(function() {
                    if (!muted) {
                        gain_node.gain.value = volume.value;
                    }
                },
                200, 500);
                var frequency = new Uint8Array(40);
                function draw_frequency() {
                    spectrum_context.clearRect(0, 0, 200, 100);
                    audio_analyser.getByteFrequencyData(frequency);
                    for (var i = 0; i < 40; i++) {
                        var value = frequency[i] / 3;
                        spectrum_context.fillRect(i * 5, 100 - value, 4, value);
                    }
                    if (!isdown) {
                        if (audio && audio.readyState > 3) {
                            slider.max = audio.duration;
                            slider.value = audio.currentTime;
                        } else {
                            slider.max = 0;
                            slider.value = 0;
                        }
                    }
                }
                script_processor.onaudioprocess = draw_frequency;
                var audio_url;
                function load_music(url) {
                    if (audio) {
                        pause();
                        media_source.disconnect(0);
                    }
                    audio = new Audio();
                    audio.src = url;
                    audio.loop = "loop";
                    audio.addEventListener("canplay",
                    function() {
                        media_source = audio_context.createMediaElementSource(audio);
                        media_source.connect(script_processor);
                        media_source.connect(audio_analyser);
                        play();
                    });
                }
                function load_music_from_file(file) {
                    if (audio_url) {
                        URL.revokeObjectURL(audio_url);
                    }
                    audio_url = URL.createObjectURL(file);
                    load_music(audio_url);
                }
                submit_file.onclick = function() {
                    if (music_file.files.length != 0) {
                        var music_file_object = music_file.files[0];
                        if (/\.(?:mp3|wav|ogg)$/i.test(music_file_object.name)) {
                            load_music_from_file(music_file_object);
                            clear_lyric();
                            if (lyric_file.files.length != 0) {
                                var lyric_file_object = lyric_file.files[0];
                                var lyric_file_reader;
                                if (/\.lrc$/i.test(lyric_file_object.name)) {
                                    read_text_from_blob(lyric_file_object,
                                    function(result) {
                                        clear_lyric();
                                        load_lyric(result);
                                    });
                                }
                                if (/\.krc$/i.test(lyric_file_object.name)) {
                                    lyric_file_reader = new FileReader();
                                    lyric_file_reader.readAsArrayBuffer(lyric_file_object);
                                    lyric_file_reader.onload = function() {
                                        krc_to_lrc(this.result,
                                        function(result) {
                                            clear_lyric();
                                            load_lyric(result);
                                        });
                                    };
                                }
                            }
                        } else {
                            alert("音乐文件过大或类型不正确！");
                        }
                    } else {
                        alert("请选择音乐文件！");
                    }
                };
                clear_lyric();
            };
        </script>
        <style type="text/css">
            *
            {
                margin: 0;
                padding: 0;
            }
            input[type=button]
            {
                padding: 5px;
            }
            #container
            {
                margin: 10px;
                padding: 5px 5px 0 5px;
                width: 500px;
                border: 1px solid #000;
                background-color: #ccc;
                border-radius: 5px;
            }
            #container div
            {
                margin-bottom: 5px;
                padding: 5px;
                border: 1px solid #000;
                background-color: #ccc;
                border-radius: 5px;
                vertical-align: middle;
            }
            #slider
            {
                width: 260px;
            }
            #volume
            {
                width: 60px;
            }
            #lyric
            {
                position: fixed;
                left: 0px;
                bottom: 0px;
                pointer-events: none;
            }
        </style>
    </head>
    <body>
        <div id="container">
            <div>
                选择文件后点击确定就可以播放音乐。<br />
                支持LRC/KRC歌词文件。<br />
                音乐文件支持*.mp3/*.wav/*.ogg。<br />
                仅支持Chrome浏览器。
            </div>
            <div>
                <label for="music-file">音乐：</label>
                <input id="music-file" type="file" />
            </div>
            <div>
                <label for="lyric-file">歌词：</label>
                <input id="lyric-file" type="file" />（可选）
            </div>
            <div>
                <input id="submit-file" type="button" value="确定" />
            </div>
            <div>
                <input id="toggle" type="button" value="播放" />
                <input id="slider" type="range" min="0" max="0" value="0" step="0.5" />
                <input id="mute" type="button" value="关闭音量" />
                <input id="volume" type="range" min="0" max="1" value="1" step="0.01" />
            </div>
            <div>
                <canvas id="spectrum" width="200" height="100"></canvas>
            </div>
        </div>
        <canvas id="lyric" height="50"></canvas>
    </body>
</html>